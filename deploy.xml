<?xml version ="1.0"?>
<!--Ant Script for create Build for caTISSUE Core-->

<project name="caTissue Core Installation" default="deploy_app">

	<!--define require dir and Properties -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="./lib/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<import file="build-properties.xml"/>
	
	<property name="base.dir" value="." />
	<property name="temp.dir" value="./tempCatissuecore" />
	<property name="csm.dir" value="${temp.dir}/tempcsm" />
	<property name="lib.dir" value="${base.dir}/lib" />
	<property name="mysql.sql.dir" value="${base.dir}/SQL/MySql" />
	<property name="dbupgrade.sql.dir" value="${base.dir}/SQL/DBUpgrade" />
	<property name="oracle.sql.dir" value="${base.dir}/SQL/Oracle" />
	<property name="common.sql.dir" value="${base.dir}/SQL/Common" />
	<property name="oracle.dialect.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.string" value="org.hibernate.dialect.MySQLDialect" />

	<property name="oracle.dialect.h3.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.h3.string" value="org.hibernate.dialect.MySQLDialect" />

	<property name="oracle.driver.string" value="oracle.jdbc.driver.OracleDriver" />
	<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver" />

	<property name="mysql.lib" value="mysql-connector-java-3.0.16-ga-bin.jar" />
	<property name="oracle.lib" value="oracleDriver.jar" />

	<!-- Check for required properties -->
	<target name="assert">
		<if>
			<equals arg1="" arg2="${jboss.home.dir}" />
			<then>
				<fail message="The property 'jboss.home.dir' can not be empty" />
			</then>
		</if>
		<if>
			<or>
				<equals arg1="mysql" arg2="${database.type}" />
				<equals arg1="oracle" arg2="${database.type}" />
			</or>
			<then />
			<else>
				<fail message="The value of property 'database.type' must be mysql or oracle" />
			</else>
		</if>
		<if>
			<equals arg1="" arg2="${database.host}" />
			<then>
				<fail message="The property 'database.host' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.port}" />
			<then>
				<fail message="The property 'database.port' can not be empty. Default port for MySQL:3306 and for Oracle: 1521" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.name}" />
			<then>
				<fail message="The property 'database.name' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.username}" />
			<then>
				<fail message="The property 'database.username' can not be empty" />
			</then>
		</if>
		<!-- Mandar 17May06 check for first user -->
		<if>
			<equals arg1="" arg2="${first.admin.department}" />
			<then>
				<fail message="The property 'first.admin.department' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.institution}" />
			<then>
				<fail message="The property 'first.admin.institution' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.cancerresearchgroup}" />
			<then>
				<fail message="The property 'first.admin.cancerresearchgroup' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.emailAddress}" />
			<then>
				<fail message="The property 'first.admin.emailAddress' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.password}" />
			<then>
				<fail message="The property 'first.admin.password' can not be empty" />
			</then>
		</if>
	</target>

	<!--Extrct WAR and copy Configuration files to temp directory-->
	<target name="init">
		<echo message="Initializing installation..." />

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
		<unwar src="${base.dir}/dynamicExtensions.war" dest="${temp.dir}/dynamicExtensions" />
		<unwar src="${base.dir}/caTissuePrintWebService.war" dest="${temp.dir}/caTissuePrintWebService" />
		

		<!-- <unwar src="${base.dir}/catissuecorecsm.war" dest="${temp.dir}/tempcsm"/> -->
		<copy todir="${temp.dir}/catissuecore-properties" overwrite="true">
			<fileset dir="${base.dir}/catissuecore-properties" />
		</copy>
		<copy file="${base.dir}/CaTIES_conf/SectionHeaderConfig.txt" todir="${temp.dir}/catissuecore-properties" overwrite="true" />
		<copy file="catissuecore-ds.xml" todir="${temp.dir}" overwrite="true" />

		<copy file="${temp.dir}/catissuecore/WEB-INF/classes/DAOConfig.xml" todir="${temp.dir}" />
		<!--Kapil V 1.0.1 Changes-->
		<copy file="login-config.xml" todir="${temp.dir}" overwrite="true" />
		<copy file="properties-service.xml" todir="${temp.dir}" overwrite="true" />
		<copy file="log4j.xml" todir="${temp.dir}" overwrite="true" />
	</target>

	<!--Modify Configuration such as Session Timeout, Admin details and JBoss server port-->
	<target name="configure_war">
		<echo message="Modifying caTissueCore Configuration File..." />

		<replace file="${temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="&lt;session-timeout>30&lt;/session-timeout>" value="&lt;session-timeout>${session.timeout}&lt;/session-timeout>" />
		</replace>

		<!--<replace file="${temp.dir}/catissuecore/WEB-INF/classes/remoteService.xml"> 
			<replacefilter token="@@server.port@@" value="${jboss.server.port}"/>
		</replace>-->
	</target>


	<!--Modify Adopter's Institution images, URL of Institution website and Contact Us, Privacy Notice, Disclaimer, Accessibility Text Files-->
	<target name="adopter_configuration">
		<echo message="Updating Site Images" />
		<copy todir="${temp.dir}/catissuecore/images" overwrite="true">
			<fileset dir="${base.dir}/images" />
		</copy>
	</target>



	<!--Modify Configuration For MySQL-->
	<target name="mysql_config">
		<echo message="Modifying caTISSUECore MySQL specific Configuration File..." />

		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
			<include name="upt.hibernate.cfg.xml" />
			<include name="catissuecore.hibernate.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${mysql.dialect.string}" />
		</replace>
		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
			<include name="orm1.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${mysql.dialect.h3.string}" />
		</replace>

		<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties">
			<include name="catissuecore-ds.xml" />
			<include name="login-config.xml" />
			<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
			<replacefilter token="@@username@@" value="${database.username}" />
			<replacefilter token="@@pasword@@" value="${database.password}" />
			<replacefilter token="@@databasedriver@@" value="${mysql.driver.string}" />
		</replace>

		<!-- change ${csm.dir} to {catissuecore} because using one war only -->
		<!-- Configuring CSM hibernate property File-->
		<!--
		<replace dir="${temp.dir}/catissuecore/WEB-INF" propertyfile="caTissueInstall.properties"> 
			<include name="classes/hibernate.properties"/>
			<include name="conf/hibernate.properties"/>
			<replacefilter 
				token="hibernate.dialect org.hibernate.dialect.MySQLDialect" 
			  	value="hibernate.dialect ${mysql.dialect.h3.string}"/>
			<replacefilter 
				token="hibernate.connection.driver_class com.mysql.jdbc.Driver" 
			  	value="hibernate.connection.driver_class ${mysql.driver.string}"/>
			
			<replacefilter 
				token="hibernate.connection.url jdbc:mysql://ps0154:3306/catissuecore_mysql" 
			  	value="hibernate.connection.url jdbc:mysql://${database.host}:${database.port}/${database.name}"/>
			<replacefilter 
				token="hibernate.connection.username catissue_core" 
			  	value="hibernate.connection.username ${database.username}"/>
			<replacefilter 
				token="hibernate.connection.password catissue_core" 
			  	value="hibernate.connection.password ${database.password}"/>
		</replace>
		-->
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>
	</target>

	<!--Modify Configuration For Oracle-->
	<target name="oracle_config">
		<echo message="Modifying caTISSUECore Oracle specific Configuration File..." />
		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
			<include name="upt.hibernate.cfg.xml" />
			<include name="catissuecore.hibernate.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${oracle.dialect.string}" />
		</replace>

		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
			<include name="orm1.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${oracle.dialect.h3.string}" />
		</replace>

		<!-- Configuring Data Source File-->
		<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties">
			<include name="catissuecore-ds.xml" />
			<include name="login-config.xml" />
			<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
			<replacefilter token="@@username@@" value="${database.username}" />
			<replacefilter token="@@pasword@@" value="${database.password}" />
			<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}" />
		</replace>

		<!-- change ${csm.dir} to {catissuecore} because using one war only -->
		<!-- Configuring CSM hibernate property File-->
		<!--
		<replace dir="${temp.dir}/catissuecore/WEB-INF" propertyfile="caTissueInstall.properties"> 
			<include name="classes/hibernate.properties"/>
			<include name="conf/hibernate.properties"/>
			<replacefilter 
				token="hibernate.dialect org.hibernate.dialect.MySQLDialect" 
			  	value="hibernate.dialect ${oracle.dialect.h3.string}"/>
			<replacefilter 
				token="hibernate.connection.driver_class com.mysql.jdbc.Driver" 
			  	value="hibernate.connection.driver_class ${oracle.driver.string}"/>
			
			<replacefilter 
				token="hibernate.connection.url jdbc:mysql://ps0154:3306/catissuecore_mysql" 
			  	value="hibernate.connection.url jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"/>
			<replacefilter 
				token="hibernate.connection.username catissue_core" 
			  	value="hibernate.connection.username ${database.username}"/>
			<replacefilter 
				token="hibernate.connection.password catissue_core" 
			  	value="hibernate.connection.password ${database.password}"/>
		</replace>
		-->
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
		</replace>
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="&lt;!--MySQL c3p properties start-->" value="&lt;!--MySQL c3p properties start" />
			<replacefilter token="&lt;!--MySQL c3p properties end-->" value="MySQL c3p properties end-->" />
		</replace>
	</target>
	<!--Server clean-up-->
	<target name="clean_server" description="deletes the WAR file and cache from server ">
		<delete file="${jboss.home.dir}/server/default/deploy/catissuecore.war" />
		<delete file="${jboss.home.dir}/server/default/deploy/dynamicExtensions.war" />
		<delete file="${jboss.home.dir}/server/default/deploy/caTissuePrintWebService.war" />
		<mkdir dir="${jboss.home.dir}/server/default/work"/>
		<mkdir dir="${jboss.home.dir}/server/default/tmp"/>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.home.dir}/server/default/work">
				<include name="**/*" />
			</fileset>
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.home.dir}/server/default/tmp">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<!--Buid New WAR File-->
	<target name="build_war">
		<echo message="Creating New Web Application Archieve File..." />
		<delete file="${temp.dir}/catissuecore.war" />
		<delete file="${temp.dir}/dynamicExtensions.war" />
		<delete file="${temp.dir}/caTissuePrintWebService.war" />

		<!-- delete file="${base.dir}/MANIFEST.MF"/>
		
		<manifest file="${base.dir}/MANIFEST.MF"> 	
	        <attribute name="Built-By" value="${user.name}"/>
	     	<attribute name="Version" value="${application.name} ${application.version}"/>
	     	<attribute name="CSM-Version" value="${csm.version}"/>
	     	<attribute name="caCore-Version" value="${cacore.version}"/>
	     	<attribute name="Build-on" value="${TODAY}"/>
	    </manifest -->		

		<war destfile="${temp.dir}/catissuecore.war" 
			webxml="${temp.dir}/catissuecore/WEB-INF/web.xml" manifest="${base.dir}/MANIFEST.MF">
			<fileset dir="${temp.dir}/catissuecore">
				<exclude name="**/*build*" />
				<exclude name="**/*WEB-INF*" />
				<exclude name="**/*servlet.jar*" />
				<exclude name="**/WEB-INF/lib/log4j-1.2.9.jar*" />
				<exclude name="**/*hibernate2.jar*" />
				<exclude name="**/*jta.jar*" />
				<exclude name="**/.*" />
				<exclude name="**/*.sql" />
				<exclude name="**/CVS*" />
			</fileset>
		</war>

		<copy file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/dynamicExtensions/WEB-INF/classes" overwrite="true" />

		<war destfile="${temp.dir}/dynamicExtensions.war" webxml="${temp.dir}/dynamicExtensions/WEB-INF/web.xml">
			<fileset dir="${temp.dir}/dynamicExtensions">
				<include name="**/**/**.*" />
			</fileset>
		</war>
		<war destfile="${temp.dir}/caTissuePrintWebService.war" webxml="${temp.dir}/caTissuePrintWebService/WEB-INF/web.xml">
					<fileset dir="${temp.dir}/caTissuePrintWebService">
						<include name="**/**/**.*" />
					</fileset>
		</war>

		<!-- change because using one war only -->
		<!--
		<delete file="${temp.dir}/catissuecorecsm.war"/>
		<war destfile="${temp.dir}/catissuecorecsm.war" webxml="${csm.dir}/WEB-INF/web.xml">
			<fileset dir="${csm.dir}"/>
		</war>
		-->
	</target>

	<!--Copy WAR and Configuration Files to JBOSS Directory-->
	<target name="copy_files">
		<echo message="Copying caTISSUECore Application Components..." />

		<copy todir="${jboss.home.dir}/server/default/catissuecore-properties" overwrite="true">
			<fileset dir="${temp.dir}/catissuecore-properties">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${jboss.home.dir}/server/default/deploy" overwrite="true">
			<fileset dir="${temp.dir}">
				<include name="catissuecore.war" />
				<include name="catissuecore-ds.xml" />
				<include name="catissuecorecsm.war" />
				<include name="dynamicExtensions.war" />
				<include name="caTissuePrintWebService.war" />
			</fileset>
		</copy>
		<replace dir="${jboss.home.dir}/server/default/catissuecore-properties">
			<include name="ApplicationSecurityConfig.xml" />
			<replacefilter token="@@hibernate-config-file@@" value="${jboss.home.dir}/server/default/catissuecore-properties/catissuecore.hibernate.cfg.xml" />
		</replace>
		<copy todir="${jboss.home.dir}/server/default/lib">
			<fileset dir="${lib.dir}">
				<include name="${mysql.lib}" />
				<include name="${oracle.lib}" />
			</fileset>
		</copy>
		<copy todir="${jboss.home.dir}/bin" overwrite="true">
			<fileset dir="${temp.dir}">
				<include name="DAOConfig.xml" />
			</fileset>
		</copy>
	</target>
	
	<!--Target call for both fresh deployment and database creation-->
	<target name="deploy_all">
		<antcall target="deploy_app" />
		<antcall target="deploy_db" />
	</target>
	
	<!--Target for fresh deployment of caTissue application-->
	<target name="deploy_app">
		<antcall target="clean_server" />
		<antcall target="assert" />
		<delete dir="${temp.dir}" />
		<antcall target="init" />
		<antcall target="configure_war" />
		<antcall target="adopter_configuration" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="oracle_config" />
				</then>
			</elseif>
		</if>
		<!-- configure titli.properties -->
		<antcall target="configure_titli" />
		<antcall target="build_war" />
		<antcall target="copy_files" />
		<replace file="${basedir}/caTissueSuite_Client/conf/remoteService.xml">
           <replacefilter token="@@HOST@@" value="${jboss.server.host}" />
           <replacefilter token="@@PORT@@" value="${jboss.server.port}" />
        </replace>
		<antcall target="send_mail" />
		<antcall target="config_jboss_files" />
		<delete dir="${temp.dir}" />
	</target>
			
	<!--Target for deployment with jboss config-->
	<target name="config_jboss_files">
		<copy todir="${jboss.home.dir}/server/default/conf" overwrite="true">
			<fileset dir="${temp.dir}">
				<include name="login-config.xml" />
				<include name="log4j.xml" />
			</fileset>
		</copy>

		<replace dir="${temp.dir}">
			<include name="properties-service.xml" />
			<replacefilter token="@@app-security-file@@" value="${jboss.home.dir}/server/default/catissuecore-properties/ApplicationSecurityConfig.xml" />
			<replacefilter token="@@app-properties-file@@" value="${jboss.home.dir}/server/default/catissuecore-properties/caTissueCore_Properties.xml" />
			<replacefilter token="@@app-dynamicuixml-file@@" value="${jboss.home.dir}/server/default/catissuecore-properties/dynamicUI.xml" />
		</replace>


		<copy todir="${jboss.home.dir}/server/default/deploy" overwrite="true">
			<fileset dir="${temp.dir}">
				<include name="properties-service.xml" />
			</fileset>
		</copy>
		<delete file="${jboss.home.dir}/server/default/lib/hibernate2.jar" />
	</target>
	
	<!--Target for Database Creation-->
	<target name="deploy_db">
		<antcall target="firstUser" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="deploy_db_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="deploy_db_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>
	
	<!--MySQL Database Creation -->
	<target name="deploy_db_mysql">
		<echo message="Initializing MySQL Database for caTISSUECore Application..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
			<transaction src="${mysql.sql.dir}/catissuecore.sql" />
			<transaction src="${mysql.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${common.sql.dir}/initDB_Insert_Common.sql" />
			<transaction src="${common.sql.dir}/AlterTable.sql" />
			<transaction src="${common.sql.dir}/CDE_DummyData_Common.sql" />
			<transaction src="${mysql.sql.dir}/csm_catissuecore.sql" />
			<transaction src="${common.sql.dir}/createUser.sql" />
			<transaction src="${common.sql.dir}/insert_default_data.sql" />
			<transaction src="${common.sql.dir}/indexes.sql" />
			<transaction src="${mysql.sql.dir}/dynamicextension.sql" />
			<transaction src="${mysql.sql.dir}/query/query_schema_script.sql" />
			<transaction src="${mysql.sql.dir}/query/caB2B Table Generation Script.sql" />
			<!-- <transaction src="${mysql.sql.dir}/query/csm.sql" /> -->
			<transaction  src="${dbupgrade.sql.dir}/MySql/CAModel.sql"/>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="CAModel_import_data" />
	</target>

	<!--Oracle Database Creation -->
	<target name="deploy_db_oracle">
		<echo message="Initializing Oracle Database for caTISSUECore Application..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/catissuecore.sql" />
			<transaction src="${oracle.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${common.sql.dir}/initDB_Insert_Common.sql" />
			<transaction src="${oracle.sql.dir}/AlterTable.sql" />
			<transaction src="${common.sql.dir}/CDE_DummyData_Common.sql" />
			<transaction src="${oracle.sql.dir}/CSM_Create_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/createUser.sql" />
			<transaction src="${oracle.sql.dir}/insert_default_data.sql" />
			<transaction src="${common.sql.dir}/indexes.sql" />
			<transaction src="${oracle.sql.dir}/dynamicextension.sql" />
			<transaction src="${oracle.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${oracle.sql.dir}/query/query_schema_script.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="insertQueryMetadata" />

		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle" delimiter="/" delimitertype="row">
			<transaction src="${oracle.sql.dir}/CSM_Trigger_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/DBUtility.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/CSM_InsertData_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/CSM_AddConstraints_Oracle.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="insertQueryMetadata">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction  src="${dbupgrade.sql.dir}/Oracle/CAModel.sql"/>
			<transaction src="${oracle.sql.dir}/query/DisableConstraints.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>	
		
		<antcall target="CAModel_import_data" />
		
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">	
			<transaction src="${oracle.sql.dir}/query/enableCons.sql" />
			<transaction src="${oracle.sql.dir}/query/UpdateTable.sql" />
			<!-- <transaction src="${oracle.sql.dir}/query/csm_oracle.sql" /> -->
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction>
			DROP SEQUENCE DE_ATTR_REC_SEQ ;                              
			DROP SEQUENCE DE_COLL_ATTR_REC_VALUES_SEQ ;        
			DROP SEQUENCE DE_FILE_ATTR_REC_VALUES_SEQ ;        
			DROP SEQUENCE DE_OBJECT_ATTR_REC_VALUES_SEQ ;      
			DROP SEQUENCE DYEXTN_ABSTRACT_METADATA_SEQ ;        
			DROP SEQUENCE DYEXTN_ASSO_DISPLAY_ATTR_SEQ ;       
			DROP SEQUENCE DYEXTN_ATTRIBUTE_TYPE_INFO_SEQ ;     
			DROP SEQUENCE DYEXTN_CONTAINER_SEQ ;               
			DROP SEQUENCE DYEXTN_CONTROL_SEQ ;                 
			DROP SEQUENCE DYEXTN_DATABASE_PROPERTIES_SEQ ;     
			DROP SEQUENCE DYEXTN_DATA_ELEMENT_SEQ ;            
			DROP SEQUENCE DYEXTN_ENTITY_MAP_CONDN_SEQ ;        
			DROP SEQUENCE DYEXTN_ENTITY_MAP_SEQ ;              
			DROP SEQUENCE DYEXTN_ENTITY_RECORD_SEQ ;           
			DROP SEQUENCE DYEXTN_FILE_EXTN_SEQ ;               
			DROP SEQUENCE DYEXTN_FORM_CONTEXT_SEQ ;            
			DROP SEQUENCE DYEXTN_PERMISSIBLEVAL_SEQ ;          
			DROP SEQUENCE DYEXTN_ROLE_SEQ ;                    
			DROP SEQUENCE DYEXTN_RULE_PARAMETER_SEQ ;          
			DROP SEQUENCE DYEXTN_RULE_SEQ ;                                   
			DROP SEQUENCE DYEXTN_SEMANTIC_PROPERTY_SEQ ;        
			DROP SEQUENCE DYEXTN_TAGGED_VALUE_SEQ ;            
			DROP SEQUENCE DYEXTN_VALUE_DOMAIN_SEQ ;            
			DROP SEQUENCE DYEXTN_VIEW_SEQ ;
			</transaction>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<transaction src="${oracle.sql.dir}/query/createDESequence.SQL" />
		</sql>
	</target>

	<!--Target for Database Upgrade from 1.2 to suite-->
	<target name="upgrade_all" depends="upgrade_app, upgrade_db">
	</target>
	
	<target name="upgrade_app" depends="deploy_app">
	</target>
	
	<target name="upgrade_db" depends="encryptPassword">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_db_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>
	
	<!--MySQL Database Upgradation -->
	<target name="upgrade_db_mysql">
		<echo message="Upgrading MySQL Database for caTISSUE Suite Application ..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_1.2_to_CatissueSuite.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/SCG_DB_changes.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/CSMUpgrade_3_to_3.2.sql"/>
			<transaction src="${mysql.sql.dir}/dynamicextension.sql" />
			<transaction src="${mysql.sql.dir}/query/query_schema_script.sql" />
			<transaction src="${mysql.sql.dir}/query/caB2B Table Generation Script.sql" />
			<!-- <transaction src="${mysql.sql.dir}/query/SuiteQueryMetadataUpdateScript.sql" />
			<transaction src="${mysql.sql.dir}/query/csm.sql" /> -->
			<transaction  src="${dbupgrade.sql.dir}/MySql/CAModel.sql"/>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="CAModel_import_data" />
	</target>
	
	
	<!--Oracle Database Upgradation -->
	<target name="upgrade_db_oracle">
		<echo message="Upgrading Oracle Database for caTISSUE Suite Application ..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/SCG_DB_changes.sql" />
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_1.2_to_CatissueSuite.sql" />
			<transaction src="${dbupgrade.sql.dir}/Oracle/CSMUpgrade_3_to_3.2.sql"/>
			<transaction src="${oracle.sql.dir}/dynamicextension.sql" />
			<transaction src="${oracle.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${oracle.sql.dir}/query/query_schema_script.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="insertQueryMetadata" />

		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle" delimiter="/" delimitertype="row">
			<transaction src="${oracle.sql.dir}/DBUtility.sql" />
			<!--transaction  src="${oracle.sql.dir}/DESeqChangeForDataDump.sql"/-->
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!--Data import for CAModel -->
	<target name="CAModel_import_data">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="CAModel_import_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_import_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete dir="${temp.dir}" />
	</target>
	
	<target name="CAModel_import_data_mysql">
		<echo message="Importing CA models data for caTISSUE Suite Application to MySQL Database ..." />
		<java classname="edu.wustl.common.util.global.AutomateImport" fork="true">
			
			<classpath refid="temp.classpath" />
			
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="import"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
		</java>
	</target>
	
	<target name="CAModel_import_data_oracle">
		<echo message="Importing CA models data for caTISSUE Suite Application to Oracle Database ..." />
		<java classname="edu.wustl.common.util.global.AutomateImport" fork="true">
			
			<classpath refid="temp.classpath" />
			
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="import"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
			<arg value="${basedir}/SQL/DBUpgrade/Oracle/CAModelCTLs/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
	</target>
		
	<!--Data export for CAModel -->
	<target name="CAModel_export_data">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="CAModel_export_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_export_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete dir="${temp.dir}" />
	</target>
	
	<target name="CAModel_export_data_mysql">
		<echo message="Exporting data of CA models for MySQL Database..." />
		<java classname="edu.wustl.common.util.global.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="export"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
		</java>
		<delete dir="${temp.dir}" />
	</target>
	
	<target name="CAModel_export_data_oracle">
		<echo message="Exporting data of CA models for Oracle Database..." />
		<java classname="edu.wustl.common.util.global.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="export"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
			<arg value="${basedir}/SQL/DBUpgrade/Oracle/CAModelCTLs/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
	</target>
	
	<!--Send mail to user-->
	<target name="send_mail">
		<echo message="Sending mail to: ${email.administrative.emailAddress}" />
		<echo message="Sending mail from: ${email.sendEmailFrom.emailAddress}" />
		<mail mailhost="${email.mailServer}" subject="caTissue Core Successfully Deployed" encoding="plain" failonerror="false">
			<from address="${email.sendEmailFrom.emailAddress}" />
			<to address="${email.administrative.emailAddress}" />
			<message>
Dear caTissue Core Administrator,
	
	This is to validate that caTissue Core application has been installed at 
the following location: ${jboss.home.dir}		
    
	To complete the deployment, you have to now perform the post installation 
steps described in section "Post Installation Configuration" in the deployment 
guide (caTissue Core Deployment Guide.doc). 

	Once you have completed deployment, you should be able to login with the following 
details:			
URL: http://localhost:${jboss.server.port}/catissuecore 
Username:${first.admin.emailAddress}
Password:${first.admin.password}

Thanking You,
-caTissue Core				
			</message>
		</mail>
		<echo>
			Please check the Email of ${first.admin.emailAddress}.
			If the Deployment mail is not received please check your 
			email.administrative.emailAddress and email.sendEmailFrom.emailAddress 
			properties in caTissueInstall.properties and Re-deploy the Application.
		</echo>
	</target>

	<!--First User Creation. Mandar : 02-May-2006 -->
	<path id="temp.classpath">
		<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
			<include name="*.jar" />
		</fileset>
	</path>
	
	<target name="firstUser">
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<antcall target="firstUser_mysql"/>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<antcall target="firstUser_oracle"/>
				</then>
			</elseif>
		</if>
	</target>
	
	<target name="firstUser_oracle">
		<echo message="Encoding Password..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
	
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">
			
			<classpath refid="temp.classpath" />
			
			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>
		
		<property file="${base.dir}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTISSUECore SQL file for user information..."/>
			<copy file="${oracle.sql.dir}/createUser.sql" todir="${temp.dir}" overwrite="true"/>

			<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties"> 
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			
			<copy todir="${oracle.sql.dir}" overwrite="true">
				<fileset dir="${temp.dir}">
					<include name="createUser.sql"/>
				</fileset>
			</copy>	
		<delete dir="${temp.dir}"/>
	</target>
	
	<target name="firstUser_mysql">
		<echo message="Encoding Password..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
	
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">
			
			<classpath refid="temp.classpath" />
			
			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>
		
		<property file="${base.dir}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTISSUECore SQL file for user information..."/>
		<copy file="${common.sql.dir}/createUser.sql" todir="${temp.dir}" overwrite="true"/>

			<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties"> 
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			
			<copy todir="${common.sql.dir}" overwrite="true">
				<fileset dir="${temp.dir}">
					<include name="createUser.sql"/>
				</fileset>
			</copy>
		<delete dir="${temp.dir}" />
	</target>

	<!--Encrypt Password-->
	<target name="encryptPassword">
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<antcall target="encryptPassword_mysql"/>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<antcall target="encryptPassword_oracle"/>
				</then>
			</elseif>
		</if>
	</target>
	
	<!--Mysql Encrypt Password-->
	<target name="encryptPassword_mysql">
		<echo message="Encrypting Password for Mysql DB..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<java classname="edu.wustl.common.util.global.PasswordEncrypter" fork="true">
			
			<classpath refid="temp.classpath" />
			
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
		</java>
		<delete dir="${temp.dir}" />
	</target>

	<!--Oracle Encrypt Password-->
	<target name="encryptPassword_oracle">
		<echo message="Encrypting Password for Oracle DB..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<java classname="edu.wustl.common.util.global.PasswordEncrypter" fork="true">
			
			<classpath refid="temp.classpath" />
			
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
		<delete dir="${temp.dir}" />
	</target>

	<!-- Configure titli.properties according to properties in caTissueInstall.properties and other set properties -->
	<target name="configure_titli">
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
			<include name="titli.properties" />
			<replacefilter token="@@username@@" value="${database.username}" />
			<replacefilter token="@@password@@" value="${database.password}" />
			<replacefilter token="@@titliindexlocation@@" value="${jboss.home.dir}/server/default/catissuecore-properties/titli-index" />
			<replacefilter token="@@databasename@@" value="${database.name}" />
			<replacefilter token="@@databasetype@@" value="${database.type}" />
		</replace>
		<!-- conditional configuration of database url and driver names -->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
					<include name="titli.properties" />
					<replacefilter token="@@databasedriver@@" value="${mysql.driver.string}" />
					<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
				<echo message="${database.type} ${database.name}" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
						<include name="titli.properties" />
						<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
						<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}" />
					</replace>
					<echo message="${database.type} ${database.name}" />
				</then>
			</elseif>
		</if>
	</target>

	<property name="filename" value="" />
	<property name="hookentity" value="" />
	<property name="mainContainerList" value="" />
	<property name="condition" value="" />
	<property name="package" value="" />

	<target name="import_xmi">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />

		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="@@DATABSE_PASSWORD@@" value="${database.password}" />
			<!--<replacefilter token="@@DATABASE_NAME@@" value="${database.name}"/>  -->
		</replace>

		<java classname="edu.wustl.catissuecore.annotations.xmi.ImportXmi" fork="true">
			<arg value="${filename}" />
			<arg value="${hookentity}" />
			<arg value="${mainContainerList}" />
			<arg value="${condition}" />
			<arg value="${package}" />
			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
			</classpath>
		</java>

		<delete includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

<!-- XMI EXPORT-->
	<property name="groupname" value="" />
	<property name="version" value="" />
	<target name="export_xmi">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />

		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="@@DATABSE_PASSWORD@@" value="${database.password}" />
			<!--<replacefilter token="@@DATABASE_NAME@@" value="${database.name}"/>  -->
		</replace>

		<java classname="edu.wustl.catissuecore.annotations.xmi.XMIExporter" fork="true">
			<arg value="${groupname}" />
			<arg value="${filename}" />
			<arg value="${version}" />
			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
					<exclude name="commons-lang-1.0.1.jar" />
				</fileset>
			</classpath>
		</java>

		<delete includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>
	
	<target name="deploy_gate" depends="assertforgate">
		<if>
			<equals arg1="yes" arg2="${deploy.gate}" />
			<then>
				<echo message="Deploying gate...." />
				<unzip src="gate.zip" dest="${jboss.home.dir}/server/default/deploy/gate.war" /> 
				<replace file="${jboss.home.dir}/server/default/deploy/gate.war/gate_3_1/application/plugins/CaTIES/creole.xml">
					<replacefilter token="@@HOST@@" value="${jboss.server.host}" />
					<replacefilter token="@@PORT@@" value="${jboss.server.port}" />
					<replacefilter token="@@MMTX_HOME@@" value="${caties.mmtx.home}" />
				</replace>
			</then>
		</if>
	</target>
	
	<target name="assertforgate">
		<if>
			<equals arg1="" arg2="${deploy.gate}" />
			<then>
				<fail message="The property 'deploy.gate' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="yes" arg2="${deploy.gate}" />
			<then>
				<if>
					<equals arg1="" arg2="${caties.mmtx.home}" />
					<then>
						<fail message="The property 'caties.mmtx.home' can not be empty" />
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${jboss.home.dir}" />
					<then>
						<fail message="The property 'jboss.home.dir' can not be empty" />
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${jboss.server.host}" />
					<then>
						<fail message="The property 'jboss.server.host' can not be empty" />
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${jboss.server.port}" />
					<then>
						<fail message="The property 'jboss.server.port' can not be empty" />
					</then>
				</if>
			</then>
		</if>
	</target>
</project>
