<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">


  <property name="text.type" value="varchar" dbms="mysql" />
  <property name="text.type" value="varchar2" dbms="oracle" />
  <property name="int.type" value="bigint(20)" dbms="mysql" />
  <property name="int.type" value="number(19,0)" dbms="oracle" />
	
  <property name="double.type" value="double" dbms="mysql" />
  <property name="double.type" value="double" dbms="oracle" />
	
  <property name="date.type" value="date" dbms="mysql" />
  <property name="date.type" value="date" dbms="oracle" />

  <property name="timestamp.type" value="timestamp" dbms="mysql" />
  <property name="timestamp.type" value="timestamp" dbms="oracle" />
   
  <changeSet id="1" author="mosin" failOnError="false">
    <addColumn tableName="CATISSUE_PARTICIPANT">
      <column name="LAB_NUMBER" type="${text.type}(255)" />
    </addColumn>
    <addColumn tableName="CATISSUE_PARTICIPANT">
      <column name="DNA_QUALITY" type="${text.type}(50)" />
    </addColumn>
  </changeSet>
	
  <changeSet id="2" author="mosin" failOnError="false">
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="DNA_METHOD" type="${text.type}(255)" />
    </addColumn>
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="DNA_260" type="${double.type}" />
    </addColumn>
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="THAW_CYCLE" type="${double.type}" />
    </addColumn>
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="LAB_NUMBER" type="${text.type}(255)" />
    </addColumn>
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="QUALITY" type="${text.type}(50)" />
    </addColumn>
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="VENESECTION_TIME" type="${timestamp.type}" />
    </addColumn>
  </changeSet>
  
  <changeSet id="adding unique constraint for LAB_NUMBER" author="nitesh" dbms="mysql">
        <sql>ALTER TABLE CATISSUE_SPECIMEN ADD CONSTRAINT idx_specimen_lab_nmbr UNIQUE (LAB_NUMBER(255))</sql>
     </changeSet>
     
    <changeSet id="adding unique constraint for LAB_NUMBER" author="nitesh" dbms="oracle">
        <createIndex 
                indexName="idx_specimen_lab_nmbr"
                tableName="CATISSUE_SPECIMEN"
                unique="true">
            <column name="LAB_NUMBER" type="varchar(255)"/>
        </createIndex>
    </changeSet>
	
  <changeSet id="3" author="catissue" failOnError="false"  dbms="oracle" >
    <sql>INSERT INTO CATISSUE_CDE VALUES ( 'Dna_Method','DNA Method','DNA Method',1.0,null)</sql>
    <sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Myomethod',NULL,'Dna_Method')</sql>
    <sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'QiaGen Salt Precipitation',NULL,'Dna_Method')</sql>
    <sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Not Specified',NULL,'Dna_Method')</sql>
	<sql>insert into catissue_permissible_value (IDENTIFIER,VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES((select max(IDENTIFIER)+1 from CATISSUE_PERMISSIBLE_VALUE),'Buffy Coat',3,null);</sql>
  </changeSet>

  <changeSet id="3" author="catissue" failOnError="false"  dbms="mysql" >
    <sql>INSERT INTO CATISSUE_CDE VALUES ( 'Dna_Method','DNA Method','DNA Method',1.0,null)</sql>
    <sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Myomethod',NULL,'Dna_Method')</sql>
    <sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('QiaGen Salt Precipitation',NULL,'Dna_Method')</sql>
    <sql>INSERT INTO CATISSUE_PERMISSIBLE_VALUE (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Not Specified',NULL,'Dna_Method')</sql>
	<sql>insert into catissue_permissible_value (VALUE, PARENT_IDENTIFIER, PUBLIC_ID) VALUES('Buffy Coat',3,null);</sql>
		
  </changeSet>
			
  <changeSet id="4" author="catissue" failOnError="false"  dbms="mysql" >
    <sql>delete from catissue_permissible_value where parent_identifier in (3) and value not in ('Serum','Whole Blood','Buffy Coat')</sql>
    <sql>delete from catissue_permissible_value where parent_identifier in (1) and value not in ('DNA')</sql>
    <sql>delete from catissue_permissible_value where parent_identifier in (2,4)</sql>
    <sql>delete from catissue_permissible_value where identifier in (2,4)</sql>
  </changeSet>

  <changeSet id="CPR_VIEW for SVH" author="mibrahim" runOnChange="true" failOnError="true">
    <sql>
      create or replace view CPR_VIEW as (
            select 
              cpr.identifier as cpr_id, cpr.collection_protocol_id as cp_id, cpr.participant_id as participant_id,
              p.first_name as first_name, p.middle_name as middle_name, p.last_name as last_name,
              p.birth_date as dob, p.social_security_number as ssn,
              cpr.activity_status as activity_status, p.gender as gender, p.genotype as genotype,
              cpr.registration_date as registration_date, cpr.protocol_participant_id as ppid,
              p.vital_status as vital_status, p.death_date as death_date, p.ethnicity as ethnicity,
              cpr.barcode as barcode, cpr.consent_sign_date as consent_sign_date, cpr.consent_witness as consent_witness,
              cpr.consent_doc_url AS consent_doc_url, p.DNA_QUALITY as dna_quality
            from 
              catissue_coll_prot_reg cpr 
              inner join catissue_participant p on cpr.participant_id = p.identifier
          );
    </sql>
  </changeSet>
</databaseChangeLog>         
