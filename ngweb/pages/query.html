<!DOCTYPE html>

<html ng-app="plus">
  <head>
    <link href="../external/select2/css/select2.css" rel="stylesheet" type="text/css"></link>
    <link href="../external/select2/css/select2-bootstrap.css" rel="stylesheet" type="text/css"></link>
    <link href="../external/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"></link>
    <link href="../external/eternicode/css/datepicker.css" rel="stylesheet" type="text/css"></link>

    <script src="../external/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="../external/jquery/jquery-ui.min.js" type="text/javascript"></script>
    <script src="../external/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../external/select2/select2.min.js" type="text/javascript"></script>
    <script src="../external/angularjs/angular.min.js" type="text/javascript"></script>
    <script src="../external/angularjs/angular-resource.min.js" type="text/javascript"></script>
    <script src="../external/angularjs/angular-sanitize.min.js" type="text/javascript"></script>
    <script src="../external/angularjs/sortable.js" type="text/javascript"></script>
    <script src="../external/angularjs/ui-bootstrap-tpls-0.10.0.min.js" type="text/javascript"></script>
    <script src="../external/eternicode/js/bootstrap-datepicker.js" type="text/javascript"></script>

    <script src="../js/wrapper.js" type="text/javascript"></script>
    <script src="../js/services.js" type="text/javascript"></script>
    <script src="../js/controllers.js" type="text/javascript"></script>
    <script src="../js/directives.js" type="text/javascript"></script>
    <script src="../js/query-directives.js" type="text/javascript"></script>
    <script src="../js/app.js" type="text/javascript"></script>
  
    <style type="text/css">
      .sortablePlaceholder {
        float: left;
        width: 2.5em;
        height: 2.5em;
      }

      .focus {
        border-color: #66AFE9;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset, 0 0 8px rgba(102, 175, 233, 0.6);
        outline: 0 none;
      }

      .op-btn {
        background-color: #f5f5f5;
        margin-bottom: 2%;
      }  

      .droppable {
        background-color: #ffffff;
        border: 1px dashed #cccccc;
      }

      .dropped {
        background-color: #ffffff;
        border: 1px solid #cccccc;
      }

      .tool-box-panel {
        height: 17%;
      }

      .z-up {
        z-index: 100;
      }

      .filter-item {
        padding: 10px 15px;
        display: block;
        border: 1px solid #DDDDDD;
        border-radius: 4px;
        margin-bottom: 1%;
      }

      .filter-item-valign {
        height: 2.5em;
        list-style-type: none;
        margin-right: 0.7em;
        padding-top: 0.5em;
        vertical-align: middle;
      }

      .filter-node {
        background-color: #cccccc; 
        width:2.5em; 
        border-radius: 50%; 
        border: 1px solid #cccccc;
        text-align: center;
      }

      .op-node {
        background-color: #f5f5f5; 
        width:2.5em; 
        border: 1px solid #cccccc;
        text-align: center;
      }

      .paren-node {
        background-color: #ffffff;
        width:1.5em;
        border: 1px solid #cccccc;
        text-align: center;
      }

      span.glyphicon-remove {
        font-size: 0.5em;
        color: #cccccc;
      }
 
      span.glyphicon-remove:focus {
        font-size: 0.5em;
        color: red;
      }

    </style>
  </head>

  <body ng-controller="QueryController">
    <div style="margin-left: 2%; width: 96%;">
      <div class="row">
        <div class="col-xs-offset-10 col-xs-2">
          <div class="btn-group pull-right">
            <div class="btn btn-default"><span class="glyphicon glyphicon-dashboard"></span></div>
            <div class="btn btn-default"><span class="glyphicon glyphicon-play"></span></div>
            <div class="btn btn-default"><span class="glyphicon glyphicon-save"></span></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-3">
          <div class="panel panel-primary"> 
            <div class="panel-heading panel-title">
              Collection Protocol
            </div>
            <div class="panel-body">
              <ka-select options="queryData.cpList" option-id="id" option-value="shortTitle" on-select="onCpSelect" style="width: 100%;"/>
            </div>
          </div>

          <accordion close-others="true">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <div class="panel-title">Forms</div>
              </div>
            </div>
            <accordion-group heading="{{form.caption}}" ng-repeat="form in queryData.cpForms" is-open="false" ng-click="onFormClick(form)">
              <div ng-show="!form.fields">
                Loading form fields. Please wait for a while...
              </div>
              <div ng-show="form.fields">
                <div style="margin-bottom: 3px;" 
                     class="field" 
                     ka-draggable="{helper: 'clone', zIndex: 100}" 
                     id="{{form.name}}.{{field.name}}" 
                     data-arg="{{form.name}}.{{field.name}}"
                     ng-repeat="field in form.fields"> {{field.caption}} </div>
              </div>
            </accordion-group>
          </accordion>
        </div>

        <div class="col-xs-9">
          <ul class="nav nav-pills nav-justified">
            <li class="active"><a href="#addFilter" data-toggle="tab">Add Filter</a></li>
            <li><a href="#editQuery" data-toggle="tab">Query Expression</a></li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade in active" id="addFilter">
              <div class="panel panel-primary">
                <div class="panel-body">
                  <div style="margin-bottom: 2%;">
                    <div class="pull-left btn-toolbar" role="toolbar" aq-filter-ops field-type="queryData.currFilter.field.dataType">
                      <div class="btn-group">
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="eq" class="op btn btn-default"> &#61; </div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="ne" class="op btn btn-default"> &#8800; </div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="lt" class="op numeric btn btn-default"> &#60; </div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="le" class="op numeric btn btn-default"> &#8804; </div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="gt" class="op numeric btn btn-default"> &#62; </div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="ge" class="op numeric btn btn-default"> &#8805; </div>
                      </div>
                      <div class="btn-group">
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="exists" class="op btn btn-default">&#8707;</div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="not_exists" class="op btn btn-default">&#8708;</div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="qin" class="op btn btn-default"> &#8712; </div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="not_in" class="op btn btn-default"> &#8713; </div>
                      </div>
                      <div class="btn-group">
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="starts_with" class="op string btn btn-default"> &#8963;&#61;</div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="ends_with" class="op string btn btn-default"> &#36;&#61;</div>
                        <div ka-draggable="{helper: 'clone', zIndex: 100}" data-arg="contains" class="op string btn btn-default"> &#126;</div>
                      </div>
                    </div>
              
                    <div class="pull-right">
                      <div class="btn-group">
                        <button type="button" class="btn btn-default active">Normal</button>
                        <button type="button" class="btn btn-default">Temporal</button>
                      </div>
                    </div>

                    <div class="clearfix"></div>
                  </div>

                  <div style="margin-bottom: 2%;">
                    <div ng-switch="!queryData.currFilter.field">
                      <div ng-switch-when="true" style="margin-right: 2%; width: 25%"
                           ka-droppable="{accept: '.field', activeClass: 'focus'}" 
                           on-drop="onFieldSelect"
                           class="btn pull-left droppable"> Form Field </div>
                      <div ng-switch-default style="margin-right: 2%; width:25%"
                           class="btn pull-left dropped"> {{queryData.currFilter.field.caption}} </div>
                    </div>
                        
                    <div ng-switch="!queryData.currFilter.op">
                      <div ng-switch-when="true" style="margin-right: 2%; width: 10%"
                           ka-droppable="{accept: '.op', activeClass: 'focus'}"
                           on-drop="onOperatorSelect"
                           class="btn pull-left droppable"> Operator </div>
                      <div ng-switch-default style="margin-right: 2%; width: 10%"
                           class="btn pull-left dropped"> <span ng-bind-html="getOpCode(queryData.currFilter.op)"></span></div>
                    </div>

                    <div ng-switch="getValueType()" style="margin-right: 2%;width:40%;" class="pull-left">
                      <div ng-switch-when="select">
                        <ka-select options="queryData.currFilter.field.pvs" ng-model="queryData.currFilter.value" style="width: 100%"></ka-select>
                      </div>
                      <div ng-switch-when="multiSelect">
                        <ka-select multiple options="queryData.currFilter.field.pvs" ng-model="queryData.currFilter.value" style="width: 100%"></ka-select>
                      </div>
                      <input ng-switch-when="datePicker" class="form-control" type="text" ka-date-picker ng-model="queryData.currFilter.value"></input>
                      <input ng-switch-default class="form-control" type="text" placeholder="Value" ng-model="queryData.currFilter.value"></input>
                    </div>

                    <div class="clearfix"></div>
                  </div>

                  <div style="margin-bottom: 2%;">
                    <div class="pull-left" style="margin-right: 2%;">
                      <label class="checkbox-inline">
                        <input type="checkbox" id="parameterized" value="1" name="parameterized">Is Parameterized?</input>
                      </label>
                    </div>
                    <div class="pull-left hidden">
                      <input class="form-control" type="text" placeholder="Filter Name"></input>
                    </div>

                    <div class="clearfix"></div>
                  </div>
                  <div style="margin-bottom: 2%;">
                    <button class="btn btn-success" ng-click="addFilter()" ng-show="!queryData.currFilter.id">Add</button>
                    <button class="btn btn-success" ng-click="editFilter()" ng-show="queryData.currFilter.id">Edit</button>
                    <button class="btn btn-default" ng-click="clearFilter()">Clear</button>
                  </div>
                </div>
              </div>
            </div> <!-- end of add filter tab -->

            <div class="tab-pane fade" id="editQuery">
              <div class="panel panel-primary">
                <div class="panel-body">
                  <div class="btn-toolbar">
                    <div class="btn-group">
                      <button type="button" class="btn btn-default" ng-click="setJoinType('all')" ng-class="{active: queryData.joinType == 'all'}">All</button>
                      <button type="button" class="btn btn-default" ng-click="setJoinType('any')" ng-class="{active: queryData.joinType == 'any'}">Any</button>
                      <button type="button" class="btn btn-default" ng-click="setJoinType('adv')" ng-class="{active: queryData.joinType == 'adv'}">Advanced</button>
                    </div>

                    <div class="btn-group" ng-show="queryData.joinType == 'adv'">
                      <div class="btn btn-default" ka-draggable="{helper: opDrag, zIndex: 100, connectToSortable: '#expr'}" data-arg="and">AND</div>
                      <div class="btn btn-default" ka-draggable="{helper: opDrag, zIndex: 100, connectToSortable: '#expr'}" data-arg="or">OR</div>
                      <div class="btn btn-default" ka-draggable="{helper: opDrag, zIndex: 100, connectToSortable: '#expr'}" data-arg="intersect">&#8745;</div>
                      <div class="btn btn-default" ka-draggable="{helper: opDrag, zIndex: 100, connectToSortable: '#expr'}" data-arg="not">NOT</div>
                    </div>

                    <div class="btn-group" ng-show="queryData.joinType == 'adv'">
                      <div class="btn btn-default" ka-draggable="{helper: opDrag, zIndex: 100, connectToSortable:'#expr'}" data-arg="(">(</div>
                      <div class="btn btn-default" ka-draggable="{helper: opDrag, zIndex: 100, connectToSortable:'#expr'}" data-arg=")">)</div>
                    </div>
                  </div>

                  <div id="expr" class="filter-item clearfix" style="width: 100%; margin-top: 2%;" ng-model="queryData.exprNodes" ui-sortable="exprSortOpts">
                    <div ng-switch="node.type" ng-repeat="node in queryData.exprNodes" class="pull-left">
                      <div ng-switch-when="filter" class="filter-item-valign filter-node">
                        <b>{{node.value}}</b>
                      </div>
                      <div ng-switch-when="op" class="filter-item-valign op-node" data-node-pos="{{$index}}" style="position: relative;">
                           <!-- ka-droppable="{accept: '.adv-op', activeClass: 'focus'}" on-drop="onAdvOpDrop" data-node-pos="{{$index}}" -->
                        <span ng-bind-html="getOpCode(node.value)"></span>
                        <span style="position: absolute; top: 0; right: 0; cursor: pointer;" class="glyphicon glyphicon-remove" ng-click="removeNode($index)"></span>
                      </div>
                      <div ng-switch-when="paren" class="filter-item-valign paren-node" style="position: relative;">
                        {{node.value}}
                        <span style="position: absolute; top: 0; right: 0; cursor: pointer;" class="glyphicon glyphicon-remove" ng-click="removeNode($index)"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- end of tabs -->

          <div class="panel panel-primary">
            <div class="panel-heading">
              <div class="panel-title">Filters</div>
            </div>
            <div class="panel-body">
              <div class="filter-item" style="display: table; width: 100%;" ng-repeat="filter in queryData.filters">
                <div class="filter-item-valign pull-left" style="background-color: #cccccc; width:2.5em; border-radius: 50%; border: 1px solid #cccccc;text-align: center;margin-right: 2%;">
                  <div><b>{{filter.id}}</b></div>
                </div>
                <div class="filter-item-valign pull-left">
                  <i>{{filter.formCaption}} &gt;&gt; {{filter.field.caption}} </i> <b> {{getOpDesc(filter.op)}} </b> <i>{{filter.value}}</i>
                </div>
                <div>
                  <div class="btn-group pull-right">
                    <button class="btn btn-default" ng-click="deleteFilter(filter)"><span class="glyphicon glyphicon-trash"></span></button>
                    <button class="btn btn-default" ng-click="displayFilter(filter)"><span class="glyphicon glyphicon-pencil"></span></button>
                  </div>
                  <div class="clearfix"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
