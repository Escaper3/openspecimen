<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping auto-import="false">
  <class
    name="com.krishagni.catissueplus.core.biospecimen.domain.CollectionProtocol"
    table="CATISSUE_COLLECTION_PROTOCOL"
    lazy="true">
    <cache usage="read-write" />

    <id name="id" column="IDENTIFIER">
      <generator class="native">
        <param name="sequence">CATISSUE_SPECIMEN_PROTOCOL_SEQ</param>
      </generator>
    </id>

    <many-to-one name="principalInvestigator" cascade="none" column="PRINCIPAL_INVESTIGATOR_ID"/>

    <property name="title" column="TITLE" unique="true"/>

    <property name="shortTitle" column="SHORT_TITLE"/>

    <property name="startDate" column="START_DATE"/>

    <property name="endDate" column="END_DATE"/>

    <property name="activityStatus" column="ACTIVITY_STATUS"/>

    <set name="cpSiteRoles" table="CATISSUE_CP_GROUP_ROLES" cascade="all-delete-orphan" inverse="false">
      <key column="CP_ID"/>
      <one-to-many class="com.krishagni.catissueplus.core.privileges.domain.CPSiteRole"/>
    </set>
         
    <sql-query name="getParticipantAndSpecimenCount">
      <return-scalar column="cpId" type="long"/>
      <return-scalar column="participantCnt" type="long"/>
      <return-scalar column="specimenCnt" type="long"/>

      select 
        cp.identifier as cpId, count(distinct cpr.identifier) as participantCnt, count(distinct sp.identifier) as specimenCnt 
      from 
        catissue_collection_protocol cp 
        left join catissue_coll_prot_reg cpr on cpr.collection_protocol_id = cp.identifier 
        left join catissue_specimen_coll_group scg on scg.collection_protocol_reg_id = cpr.identifier 
        left join catissue_specimen sp on sp.specimen_collection_group_id = scg.identifier 
      where
        cp.activity_status = 'Active'
      group by 
        cp.identifier
    </sql-query>
  </class>
</hibernate-mapping>
