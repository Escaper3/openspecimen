<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog 
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <changeSet author="vgaikwad" id="Column to specify specimen label pre print mode">
    <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
      <column name="SPMN_LABEL_PRE_PRINT_MODE" type="${text.type}(32)">
      </column>
    </addColumn>
  </changeSet>
  
  <changeSet author="vgaikwad" id="Column to specify specimen label auto print mode">
    <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
      <column name="LABEL_AUTO_PRINT_MODE" type="${text.type}(32)">
      </column>
    </addColumn>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Rename date to migration_date in os_migraitons table">
    <renameColumn
      columnDataType="${timestamp.type}"
      oldColumnName="DATE"
      newColumnName="MIGRATION_DATE"
      tableName="OS_MIGRATIONS"/>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Added temporary column tmp_description in specimen list tag table" dbms="oracle">
    <addColumn tableName="CATISSUE_SPECIMENLIST_TAGS">
      <column name="TMP_DESCRIPTION" type="${text.type}(1000)"/>
    </addColumn>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Moving data from clob to newly created varchar column" dbms="oracle">
    <sql>
      update 
        catissue_specimenlist_tags
      set 
        tmp_description = DBMS_LOB.SUBSTR (description, 1000);
    </sql>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Delete the original description column" dbms="oracle">
    <dropColumn tableName="CATISSUE_SPECIMENLIST_TAGS" columnName="DESCRIPTION"/>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Rename to temporary column to the actual one" dbms="oracle">
    <renameColumn
      columnDataType="${text.type}(1000)"
      oldColumnName="TMP_DESCRIPTION"
      newColumnName="DESCRIPTION"
      tableName="CATISSUE_SPECIMENLIST_TAGS"/>
  </changeSet>
  
  <changeSet author="slakhani" id="Drop distribution orders view if exists">
    <preConditions onFail="MARK_RAN">
      <viewExists viewName="specimen_distribution_orders_view"/>
    </preConditions>
    <dropView viewName="specimen_distribution_orders_view"/>
  </changeSet>
  
  <changeSet author="vlonushte" id="Creating specimen distribution orders view" runOnChange="true">
    <createView viewName="os_spmn_distributions_view">
      select
        item.identifier as identifier, item.specimen_id as specimen_id, item.quantity as quantity, item.status as status,
        ord.name as name, ord.requester_id as requester_id, ord.distributor_id as distributor_id, 
        ord.execution_date as execution_date, ord.comments as comments, dp.short_title as dp_short_title
      from
        os_order_items item
        inner join os_orders ord on item.order_id = ord.identifier
        inner join catissue_distribution_protocol dp on ord.distribution_protocol_id = dp.identifier
      where
        ord.status != 'PENDING'
    </createView>
  </changeSet>
  
  <changeSet author="vlonushte" id="Migrating distributed event data">
    <validCheckSum>7:cb8a3cc4f3210d48579fccbc8124adf5</validCheckSum>
    <preConditions onFail="MARK_RAN">
      <sqlCheck expectedResult="1">
        select
          count(identifier)
        from 
          dyextn_containers
        where
          name = 'SpecimenDistributedEvent'
      </sqlCheck>
    </preConditions>
    <sql dbms="mysql">
      select 
        fc.identifier into @form_ctxt_id 
      from 
        catissue_form_context fc 
        inner join dyextn_containers dc on dc.identifier = fc.container_id 
      where 
        dc.name = 'SpecimenDistributedEvent';

      delete from catissue_form_record_entry where form_ctxt_id = @form_ctxt_id;

      insert into catissue_form_record_entry
        (form_ctxt_id, object_id, record_id, updated_by, update_time, activity_status)
      (select 
         @form_ctxt_id, do.specimen_id, do.identifier, do.distributor_id, do.execution_date, 'ACTIVE'
       from 
         os_spmn_distributions_view do)
    </sql> 

    <sql dbms="oracle" endDelimiter="//">
      declare 
        form_ctxt_id number;
      begin 
        select 
          fc.identifier into form_ctxt_id 
        from 
          catissue_form_context fc 
          inner join dyextn_containers dc on dc.identifier = fc.container_id 
        where 
          dc.name = 'SpecimenDistributedEvent';

        delete from catissue_form_record_entry where form_ctxt_id = form_ctxt_id;

        insert into catissue_form_record_entry
          (identifier, form_ctxt_id, object_id, record_id, updated_by, update_time, activity_status)
        (select 
           catissue_form_rec_entry_seq.nextval, form_ctxt_id, do.specimen_id, 
           do.identifier, do.distributor_id, do.execution_date, 'ACTIVE'
         from 
           os_spmn_distributions_view do);
      end;
      //     
    </sql>

    <dropTable tableName="CATISSUE_DISTRI_EVENT_PARAM"/>
  </changeSet>

  <changeSet author="slakhani" id="Table to track OpenSpecimen upgrades">
    <createTable tableName="OS_UPGRADE_LOG">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      
      <column name="VERSION" type="${text.type}(64)">
        <constraints nullable="false" />
      </column>
      
      <column name="UPGRADE_DATE" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>
      
      <column name="UPGRADED_BY" type="${text.type}(128)">
      </column>
    </createTable>
  </changeSet>
  
  <changeSet author="slakhani" id="OS_UPGRADE_LOG table sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_UPGRADE_LOG_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vpawar" id="Specimen requests table">
    <createTable tableName="OS_SPECIMEN_REQUESTS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="CP_ID" type="${int.type}">
        <constraints nullable="false" />
      </column>

      <column name="REQUESTOR_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="REQUEST_DATE" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>

      <column name="PROCESSOR_ID" type="${int.type}">
      </column>

      <column name="PROCESSING_DATE" type="${nullable.ts.type}">
      </column>

      <column name="COMMENTS" type="${text.type}(255)">
      </column>

      <column name="ACTIVITY_STATUS" type="${text.type}(16)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Specimen requests sequence" dbms="oracle">
    <createSequence
      sequenceName="OS_SPECIMEN_REQUESTS_SEQ"
      startValue="1"
      incrementBy="1"
      ordered="true"/>
  </changeSet>

  <changeSet author="vpawar" id="FK on specimen request CP">
    <addForeignKeyConstraint
      constraintName="FK_OS_SPMN_REQS_CP_ID"
      baseTableName="OS_SPECIMEN_REQUESTS"
      baseColumnNames="CP_ID"
      referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="FK on specimen requestor">
    <addForeignKeyConstraint
      constraintName="FK_OS_SPMN_REQS_REQUESTOR"
      baseTableName="OS_SPECIMEN_REQUESTS"
      baseColumnNames="REQUESTOR_ID"
      referencedTableName="CATISSUE_USER"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="FK on specimen request processor">
    <addForeignKeyConstraint
      constraintName="FK_OS_SPMN_REQS_PROCESSOR"
      baseTableName="OS_SPECIMEN_REQUESTS"
      baseColumnNames="PROCESSOR_ID"
      referencedTableName="CATISSUE_USER"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Specimen request specimens table">
    <createTable tableName="OS_SPECIMEN_REQUEST_ITEMS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="REQUEST_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="SPECIMEN_ID" type="${int.type}">
        <constraints nullable="false" />
      </column>

      <column name="STATUS" type="${text.type}(32)">
        <constraints nullable="false" />
      </column>

      <column name="DISTRIBUTION_ID" type="${int.type}">
      </column>

      <column name="SHIPMENT_ID" type="${int.type}">
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Specimen request specimens sequence" dbms="oracle">
    <createSequence
      sequenceName="OS_SPECIMEN_REQUEST_ITEMS_SEQ"
      startValue="1"
      incrementBy="1"
      ordered="true"/>
  </changeSet>

  <changeSet author="vpawar" id="FK on specimen request ID">
    <addForeignKeyConstraint
      constraintName="FK_OS_REQ_SPMNS_REQ_ID"
      baseTableName="OS_SPECIMEN_REQUEST_ITEMS"
      baseColumnNames="REQUEST_ID"
      referencedTableName="OS_SPECIMEN_REQUESTS"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="FK on requested specimen ID">
    <addForeignKeyConstraint
      constraintName="FK_OS_REQ_SPMNS_SPMN_ID"
      baseTableName="OS_SPECIMEN_REQUEST_ITEMS"
      baseColumnNames="SPECIMEN_ID"
      referencedTableName="CATISSUE_SPECIMEN"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="FK on requested specimen distribution ID">
    <addForeignKeyConstraint
      constraintName="FK_OS_REQ_SPMNS_DIST_ID"
      baseTableName="OS_SPECIMEN_REQUEST_ITEMS"
      baseColumnNames="DISTRIBUTION_ID"
      referencedTableName="OS_ORDERS"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>
  
  <changeSet author="vpawar" id="FK on requested specimen shipment ID">
    <addForeignKeyConstraint
      constraintName="FK_OS_REQ_SPMNS_SHIP_ID"
      baseTableName="OS_SPECIMEN_REQUEST_ITEMS"
      baseColumnNames="SHIPMENT_ID"
      referencedTableName="OS_SHIPMENTS"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Request for which distribution is created">
    <addColumn tableName="OS_ORDERS">
      <column name="REQUEST_ID" type="${int.type}">
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on distribution order request">
    <addForeignKeyConstraint
      constraintName="FK_OS_ORDERS_REQ_ID"
      baseTableName="OS_ORDERS"
      baseColumnNames="REQUEST_ID"
      referencedTableName="OS_SPECIMEN_REQUESTS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Request for which the shipment is created">
    <addColumn tableName="OS_SHIPMENTS">
      <column name="REQUEST_ID" type="${int.type}">
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on shipment request">
    <addForeignKeyConstraint
      constraintName="FK_OS_SHIPMENTS_REQ_ID"
      baseTableName="OS_SHIPMENTS"
      baseColumnNames="REQUEST_ID"
      referencedTableName="OS_SPECIMEN_REQUESTS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>
</databaseChangeLog>
