<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog 
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <changeSet author="vgaikwad" id="Column to specify specimen label pre print mode">
    <addColumn tableName="CATISSUE_COLLECTION_PROTOCOL">
      <column name="SPMN_LABEL_PRE_PRINT_MODE" type="${text.type}(32)">
      </column>
    </addColumn>
  </changeSet>
  
  <changeSet author="vgaikwad" id="Column to specify specimen label auto print mode">
    <addColumn tableName="CATISSUE_CP_REQ_SPECIMEN">
      <column name="LABEL_AUTO_PRINT_MODE" type="${text.type}(32)">
      </column>
    </addColumn>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Rename date to migration_date in os_migraitons table">
    <renameColumn
      columnDataType="${timestamp.type}"
      oldColumnName="DATE"
      newColumnName="MIGRATION_DATE"
      tableName="OS_MIGRATIONS"/>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Added temporary column tmp_description in specimen list tag table" dbms="oracle">
    <addColumn tableName="CATISSUE_SPECIMENLIST_TAGS">
      <column name="TMP_DESCRIPTION" type="${text.type}(1000)"/>
    </addColumn>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Moving data from clob to newly created varchar column" dbms="oracle">
    <sql>
      update 
        catissue_specimenlist_tags
      set 
        tmp_description = DBMS_LOB.SUBSTR (description, 1000);
    </sql>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Delete the original description column" dbms="oracle">
    <dropColumn tableName="CATISSUE_SPECIMENLIST_TAGS" columnName="DESCRIPTION"/>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Convert clob to varchar: Rename to temporary column to the actual one" dbms="oracle">
    <renameColumn
      columnDataType="${text.type}(1000)"
      oldColumnName="TMP_DESCRIPTION"
      newColumnName="DESCRIPTION"
      tableName="CATISSUE_SPECIMENLIST_TAGS"/>
  </changeSet>
  
  <changeSet author="vlonushte" id="Creating specimen distribution orders view">
    <createView viewName="specimen_distribution_orders_view">
      select
        item.identifier as identifier, item.specimen_id as specimen_id, item.quantity as quantity, item.status as status,
        ord.name as name, ord.requester_id as requester_id, ord.distributor_id as distributor_id, 
        ord.execution_date as execution_date, ord.comments as comments, dp.short_title as dp_short_title
      from
        os_order_items item
        inner join os_orders ord on item.order_id = ord.identifier
        inner join catissue_distribution_protocol dp on ord.distribution_protocol_id = dp.identifier
      where
        ord.status != 'PENDING'
    </createView>
  </changeSet>

  <changeSet author="vlonushte" id="Migrating distributed event data">
    <sql dbms="mysql">
      select 
        fc.identifier into @form_ctxt_id 
      from 
        catissue_form_context fc 
        inner join dyextn_containers dc on dc.identifier = fc.container_id 
      where 
        dc.name = 'SpecimenDistributedEvent';

      delete from catissue_form_record_entry where form_ctxt_id = @form_ctxt_id;

      insert into catissue_form_record_entry
        (form_ctxt_id, object_id, record_id, updated_by, update_time, activity_status)
      (select 
         @form_ctxt_id, do.specimen_id, do.identifier, do.distributor_id, do.execution_date, 'ACTIVE'
       from 
         specimen_distribution_orders_view do) 
    </sql> 

    <sql dbms="oracle" endDelimiter="//">
      declare 
        form_ctxt_id number;
      begin 
        select 
          fc.identifier into form_ctxt_id 
        from 
          catissue_form_context fc 
          inner join dyextn_containers dc on dc.identifier = fc.container_id 
        where 
          dc.name = 'SpecimenDistributedEvent';

        delete from catissue_form_record_entry where form_ctxt_id = form_ctxt_id;

        insert into catissue_form_record_entry
          (identifier, form_ctxt_id, object_id, record_id, updated_by, update_time, activity_status)
        (select 
           catissue_form_rec_entry_seq.nextval, form_ctxt_id, do.specimen_id, 
           do.identifier, do.distributor_id, do.execution_date, 'ACTIVE'
         from 
           specimen_distribution_orders_view do); 
      end;
      //     
    </sql>

    <dropTable tableName="CATISSUE_DISTRI_EVENT_PARAM"/>
  </changeSet>

  <changeSet author="slakhani" id="Table to track OpenSpecimen upgrades">
    <createTable tableName="OS_UPGRADE_LOG">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      
      <column name="VERSION" type="${text.type}(64)">
        <constraints nullable="false" />
      </column>
      
      <column name="UPGRADE_DATE" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>
      
      <column name="UPGRADED_BY" type="${text.type}(128)">
      </column>
    </createTable>
  </changeSet>
  
  <changeSet author="slakhani" id="OS_UPGRADE_LOG table sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_UPGRADE_LOG_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="hkambale" id="Creating participant visit summary view">
    <createView viewName="os_participant_visit_view">
      select
        participant.identifier,
        ccpr.protocol_participant_id,
        sum(if(scg.collection_status = "Complete", 1, 0)) as visits_completed,
        sum(if(scg.collection_status = "Missed Collection", 1, 0)) as visits_missed,
        sum(if((scg.identifier is null or scg.collection_status = "Pending"), 1, 0)) as visits_pending
      from
        catissue_collection_protocol cp
        join catissue_coll_prot_reg ccpr on ccpr.collection_protocol_id = cp.identifier
        join catissue_coll_prot_event cpe on cpe.collection_protocol_id = cp.identifier
        join catissue_participant participant on ccpr.participant_id = participant.identifier
        left join catissue_specimen_coll_group scg on scg.collection_protocol_event_id = cpe.identifier and
        ccpr.identifier = scg.collection_protocol_reg_id
      group by
        ccpr.protocol_participant_id
    </createView>
  </changeSet>

  <changeSet author="hkambale" id="Creating participant specimen summary view">
    <createView viewName="os_participant_specimen_view">
      select
        participant.identifier,
        ccpr.protocol_participant_id,
        sum(if(spec.collection_status = "Collected", 1, 0)) as specimens_collected,
        sum(if(spec.collection_status = "Missed Collection", 1, 0)) as specimens_missed,
        sum(if((spec.identifier is null or spec.collection_status = "Pending"), 1, 0)) as specimens_pending
      from
        catissue_collection_protocol cp
        join catissue_coll_prot_reg ccpr on ccpr.collection_protocol_id = cp.identifier
        join catissue_coll_prot_event cpe on cpe.collection_protocol_id = cp.identifier
        join catissue_cp_req_specimen sr on sr.collection_protocol_event_id = cpe.identifier
        join catissue_participant participant on ccpr.participant_id = participant.identifier
        left join catissue_specimen_coll_group scg on scg.collection_protocol_event_id = cpe.identifier and
        ccpr.identifier = scg.collection_protocol_reg_id
        left join catissue_specimen spec on spec.specimen_collection_group_id = scg.identifier and
        sr.identifier = spec.req_specimen_id
      group by
        ccpr.protocol_participant_id
    </createView>
  </changeSet>

</databaseChangeLog>
