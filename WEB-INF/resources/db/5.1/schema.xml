<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet author="vpawar" id="Column specifying whether the entire import job was run in a single transaction">
    <addColumn tableName="OS_BULK_IMPORT_JOBS">
      <column name="ATOMIC" type="${boolean.type}"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Specimen carts view">
    <createView viewName="OS_SPECIMEN_CARTS_VIEW" replaceIfExists="true">
      select
        ci.obj_id as specimen_id, c.tag_label as name, ci.identifier as item_id
      from
        catissue_specimenlist_tags c
        inner join catissue_spec_tag_items ci on ci.tag_id = c.identifier
      where
        c.deleted_on is null
    </createView>
  </changeSet>

  <changeSet author="vpawar" id="Storage container usage mode">
    <addColumn tableName="OS_STORAGE_CONTAINERS">
      <column name="USED_FOR" type="${text.type}(32)" defaultValue="STORAGE">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Container allowed DPs">
    <createTable tableName="OS_STOR_CONTAINER_DPS">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="DP_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on container ID of container allowed DPs">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_DP_CONT_ID"
      baseTableName="OS_STOR_CONTAINER_DPS" baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on DP ID of container allowed DPs">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_DP_DP_ID"
      baseTableName="OS_STOR_CONTAINER_DPS" baseColumnNames="DP_ID"
      referencedTableName="CATISSUE_DISTRIBUTION_PROTOCOL" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Container allowed DPs - computed set">
    <createTable tableName="OS_STOR_CONTAINER_COMP_DPS">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="DP_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on container ID of container allowed DPs - computed set">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_CDPS_CONT_ID"
      baseTableName="OS_STOR_CONTAINER_COMP_DPS" baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on DP ID of container allowed DPs - computed set">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_CDPS_DP_ID"
      baseTableName="OS_STOR_CONTAINER_COMP_DPS" baseColumnNames="DP_ID"
      referencedTableName="CATISSUE_DISTRIBUTION_PROTOCOL" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Specimens requestor ID">
    <preConditions onFail="MARK_RAN">
      <not>
        <columnExists tableName="OS_SPECIMEN_REQUESTS" columnName="REQUESTOR_ID"/>
      </not>
    </preConditions>
    <addColumn tableName="OS_SPECIMEN_REQUESTS">
      <column name="REQUESTOR_ID" type="${int.type}"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on specimen requestor ID">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyTableName="OS_SPECIMEN_REQUESTS" foreignKeyName="FK_OS_SPMN_REQS_REQUESTOR"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint
      constraintName="FK_OS_SPMN_REQS_REQUESTOR"
      baseTableName="OS_SPECIMEN_REQUESTS" baseColumnNames="REQUESTOR_ID"
      referencedTableName="CATISSUE_USER" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Setting to control DP email notifications">
    <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
      <column name="DISABLE_EMAIL_NOTIFS" type="${boolean.type}"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Specimen external identifiers">
    <createTable tableName="OS_SPMN_EXTERNAL_IDS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints nullable="false" primaryKey="true"/>
      </column>
      <column name="SPECIMEN_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="NAME" type="${text.type}(128)">
        <constraints nullable="false"/>
      </column>
      <column name="VALUE" type="${text.type}(128)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Specimen external identifiers sequence" dbms="oracle">
    <createSequence sequenceName="OS_SPMN_EXT_ID_SEQ" incrementBy="1" minValue="1" ordered="true"/>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on specimen ID of external identifiers">
    <addForeignKeyConstraint constraintName="FK_EXT_IDS_SPMN_ID"
      baseTableName="OS_SPMN_EXTERNAL_IDS" baseColumnNames="SPECIMEN_ID"
      referencedTableName="CATISSUE_SPECIMEN" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Association of saved query with collection protocol">
    <addColumn tableName="CATISSUE_SAVED_QUERIES">
      <column name="CP_ID" type="${int.type}"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on saved query CP">
    <addForeignKeyConstraint constraintName="FK_SAVED_QUERY_CP"
      baseTableName="CATISSUE_SAVED_QUERIES" baseColumnNames="CP_ID"
      referencedTableName="CATISSUE_COLLECTION_PROTOCOL" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Update CP ID of all saved queries">
    <customChange class="com.krishagni.catissueplus.core.upgrade.InitializeSavedQueryCpId"/>
  </changeSet>

  <changeSet author="vpawar" id="Query dependencies">
    <createTable tableName="OS_SAVED_QUERY_DEPS">
      <column name="QUERY_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="SUB_QUERY_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on parent query">
    <addForeignKeyConstraint constraintName="FK_DEPS_PARENT_QUERY"
      baseTableName="OS_SAVED_QUERY_DEPS" baseColumnNames="QUERY_ID"
       referencedTableName="CATISSUE_SAVED_QUERIES" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on child query">
    <addForeignKeyConstraint constraintName="FK_DEPS_CHILD_QUERY"
      baseTableName="OS_SAVED_QUERY_DEPS" baseColumnNames="SUB_QUERY_ID"
      referencedTableName="CATISSUE_SAVED_QUERIES" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Specimen image ID / URL">
    <addColumn tableName="CATISSUE_SPECIMEN">
      <column name="IMAGE_ID" type="${text.type}(255)"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Unique constraint on participant eMPI">
    <addUniqueConstraint constraintName="PART_EMPI_ID_UQ" tableName="CATISSUE_PARTICIPANT" columnNames="EMPI_ID"/>
  </changeSet>

  <changeSet author="vpawar" id="Updated user view to include system user" runOnChange="true">
    <sql>
      create or replace view USER_VIEW as (
        select
          u.identifier as identifier, u.first_name as first_name, u.last_name as last_name,
          u.email_address as email_address, concat(u.first_name, concat(' ', u.last_name)) as name,
          i.name as institute_name, s.identifier as primary_site_id, s.name as primary_site_name
        from
          catissue_user u
          left join catissue_institution i on i.identifier = u.institute_id
          left join catissue_site s on s.identifier = u.primary_site_id
        where
          u.activity_status != 'Disabled' and
          (u.login_name = '$system' or i.activity_status != 'Disabled') and
          (s.identifier is null or s.activity_status != 'Disabled')
      )
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Specimen requests view - used in query interface" runOnChange="true">
    <createView viewName="os_specimen_requests_view" replaceIfExists="true">
      select
        ri.identifier as identifier, ri.specimen_id as specimen_id, r.identifier as request_id,
        r.requestor_email_id as requestor_email_id, r.requestor_id as requestor_id,
        r.request_date as req_date, r.screening_status as screening_status,
        r.screening_date as screening_date, r.processing_date as processing_date,
        r.activity_status as activity_status
      from
        os_specimen_requests r
        inner join os_specimen_request_items ri on ri.request_id = r.identifier
      where
        r.activity_status != 'Disabled'
    </createView>
  </changeSet>
</databaseChangeLog>
