<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet author="vpawar" id="Column specifying whether the entire import job was run in a single transaction">
    <addColumn tableName="OS_BULK_IMPORT_JOBS">
      <column name="ATOMIC" type="${boolean.type}"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Specimen carts view">
    <createView viewName="OS_SPECIMEN_CARTS_VIEW" replaceIfExists="true">
      select
        ci.obj_id as specimen_id, c.tag_label as name, ci.identifier as item_id
      from
        catissue_specimenlist_tags c
        inner join catissue_spec_tag_items ci on ci.tag_id = c.identifier
      where
        c.deleted_on is null
    </createView>
  </changeSet>

  <changeSet author="vpawar" id="Storage container usage mode">
    <addColumn tableName="OS_STORAGE_CONTAINERS">
      <column name="USED_FOR" type="${text.type}(32)" defaultValue="STORAGE">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Container allowed DPs">
    <createTable tableName="OS_STOR_CONTAINER_DPS">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="DP_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on container ID of container allowed DPs">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_DP_CONT_ID"
      baseTableName="OS_STOR_CONTAINER_DPS" baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on DP ID of container allowed DPs">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_DP_DP_ID"
      baseTableName="OS_STOR_CONTAINER_DPS" baseColumnNames="DP_ID"
      referencedTableName="CATISSUE_DISTRIBUTION_PROTOCOL" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Container allowed DPs - computed set">
    <createTable tableName="OS_STOR_CONTAINER_COMP_DPS">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="DP_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on container ID of container allowed DPs - computed set">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_CDPS_CONT_ID"
      baseTableName="OS_STOR_CONTAINER_COMP_DPS" baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on DP ID of container allowed DPs - computed set">
    <addForeignKeyConstraint constraintName="FK_OS_STORE_CONT_CDPS_DP_ID"
      baseTableName="OS_STOR_CONTAINER_COMP_DPS" baseColumnNames="DP_ID"
      referencedTableName="CATISSUE_DISTRIBUTION_PROTOCOL" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Specimens requestor ID">
    <preConditions onFail="MARK_RAN">
      <not>
        <columnExists tableName="OS_SPECIMEN_REQUESTS" columnName="REQUESTOR_ID"/>
      </not>
    </preConditions>
    <addColumn tableName="OS_SPECIMEN_REQUESTS">
      <column name="REQUESTOR_ID" type="${int.type}"/>
    </addColumn>
  </changeSet>

  <changeSet author="vpawar" id="Foreign key on specimen requestor ID">
    <preConditions onFail="MARK_RAN">
      <not>
        <foreignKeyConstraintExists foreignKeyTableName="OS_SPECIMEN_REQUESTS" foreignKeyName="FK_OS_SPMN_REQS_REQUESTOR"/>
      </not>
    </preConditions>
    <addForeignKeyConstraint
      constraintName="FK_OS_SPMN_REQS_REQUESTOR"
      baseTableName="OS_SPECIMEN_REQUESTS" baseColumnNames="REQUESTOR_ID"
      referencedTableName="CATISSUE_USER" referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Setting to control DP email notifications">
    <addColumn tableName="CATISSUE_DISTRIBUTION_PROTOCOL">
      <column name="DISABLE_EMAIL_NOTIFS" type="${boolean.type}"/>
    </addColumn>
  </changeSet>
</databaseChangeLog>
