<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog 
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
        

  <changeSet author="nmarwaha" id="Specimen collection status migration">
    <sql>
      update 
        catissue_specimen 
      set 
        collection_status = 'Missed Collection' 
      where 
        collection_status not in ('Collected', 'Pending')
    </sql>
  </changeSet>
  
    <changeSet author="nmarwaha" id="Update the DP's default institute ID from the PI">
    <sql>
      update 
        catissue_distribution_protocol dp 
        join catissue_user u on u.identifier = dp.principal_investigator_id
        join os_departments dep on dep.identifier = u.department_id
        join catissue_institution inst on inst.identifier = dep.institute_id
      set 
        dp.institute_id = inst.identifier 
    </sql>
  </changeSet>
  
  <changeSet author="nmarwaha" id="Update the requestor ID to PI if not specified">
    <sql>
      update 
        catissue_order ordr
        join catissue_distribution_protocol dp on ordr.distribution_protocol_id = dp.identifier
        join catissue_user u on u.identifier = dp.principal_investigator_id
      set 
        ordr.requester_id = u.identifier 
      where 
        ordr.requester_id is null
    </sql>
  </changeSet>
  
  <changeSet author="rvivek" id="Migrating order and distribution data" >
    <sql>
      INSERT INTO OS_ORDERS (
        IDENTIFIER, 
        NAME, 
        REQUESTER_ID, 
        CREATION_DATE, 
        EXECUTION_DATE, 
        STATUS, 
        ORDER_TYPE, 
        ACTIVITY_STATUS, 
        SITE_ID, 
        DISTRIBUTION_PROTOCOL_ID, 
        DISTRIBUTOR_ID, 
        TRACKING_URL, 
        COMMENTS)

      SELECT 
        CATISSUE_ORDER.IDENTIFIER AS 'IDENTIFIER', 
        CATISSUE_ORDER.NAME AS 'NAME',
        CATISSUE_ORDER.REQUESTER_ID AS 'REQUESTER_ID', 
        CATISSUE_ORDER.REQUESTED_DATE AS 'CREATION_DATE',
        CATISSUE_DISTRIBUTION.EVENT_TIMESTAMP AS 'EXECUTION_DATE',
        CASE 
          WHEN CATISSUE_ORDER.STATUS IN ('Completed') THEN 'EXECUTED'
          ELSE 'PENDING'
        END AS 'STATUS',
        NULL AS 'ORDER_TYPE',
        CATISSUE_DISTRIBUTION.ACTIVITY_STATUS AS 'ACTIVITY_STATUS',
        CATISSUE_DISTRIBUTION.TO_SITE_ID AS 'SITE_ID',
        CATISSUE_DISTRIBUTION.DISTRIBUTION_PROTOCOL_ID AS 'DISTRIBUTION_PROTOCOL_ID',
        CATISSUE_DISTRIBUTION.USER_ID AS 'DISTRIBUTOR_ID',
        NULL AS 'TRACKING_URL',
        CATISSUE_ORDER.COMMENTS AS 'COMMENTS'
      FROM 
        CATISSUE_ORDER
       JOIN CATISSUE_DISTRIBUTION ON CATISSUE_DISTRIBUTION.ORDER_ID=CATISSUE_ORDER.IDENTIFIER
       AND CATISSUE_DISTRIBUTION.ORDER_ID IS NOT NULL;
    </sql>
    
    <sql>
      INSERT INTO OS_ORDER_ITEMS (
        IDENTIFIER, 
        ORDER_ID, 
        QUANTITY, 
        SPECIMEN_ID, 
        STATUS)
        
      SELECT 
        CATISSUE_ORDER_ITEM.IDENTIFIER AS 'IDENTIFIER',
        CATISSUE_ORDER_ITEM.ORDER_ID AS 'ORDER_ID',
        CATISSUE_ORDER_ITEM.REQUESTED_QUANTITY AS 'QUANTITY',
        CATISSUE_DISTRIBUTED_ITEM.SPECIMEN_ID AS 'SPECIMEN_ID',
        CASE
          WHEN CATISSUE_ORDER_ITEM.STATUS LIKE 'Distributed And Close' THEN 'DISTRIBUTED_AND_CLOSED'
          WHEN CATISSUE_ORDER_ITEM.STATUS LIKE 'Distributed' THEN 'DISTRIBUTED'
          WHEN CATISSUE_ORDER_ITEM.STATUS IN ('New', 'Pending - For Distribution') THEN 'PENDING'
          ELSE 'TEMP'
        END AS 'STATUS'
      FROM 
        CATISSUE_ORDER_ITEM
        JOIN CATISSUE_DISTRIBUTED_ITEM ON CATISSUE_DISTRIBUTED_ITEM.IDENTIFIER=CATISSUE_ORDER_ITEM.DISTRIBUTED_ITEM_ID
        JOIN CATISSUE_DISTRIBUTION ON CATISSUE_DISTRIBUTION.IDENTIFIER=CATISSUE_DISTRIBUTED_ITEM.DISTRIBUTION_ID
        AND CATISSUE_DISTRIBUTION.ORDER_ID IS NOT NULL;
    </sql>
  </changeSet>
  
</databaseChangeLog>
