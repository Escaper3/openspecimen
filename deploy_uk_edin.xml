<?xml version ="1.0"?>
<!--Ant Script for create Build for caTissue Suite-->

<project name="caTissue Suite v1.1 Installation EDIN" default="matadata_change_for_edin">

	<!--define require dir and Properties -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="./lib/ant-contrib.jar" />
		</classpath>
	</taskdef>
	
	<import file="build-properties.xml"/>
	<property name="base.dir" value="." />
	<property name="temp.dir" value="./deploytempCatissuecore" />
	<property name="lib.dir" value="${base.dir}/lib" />
	<property name="common.sql.dir" value="${base.dir}/SQL/Common" />
	<property name="oracle.sql.dir" value="${base.dir}/SQL/Oracle" />
	<property name="oracle.driver.string" value="oracle.jdbc.driver.OracleDriver" />
	<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver" />
	<property name="mssqlserver.driver.string" value="com.microsoft.sqlserver.jdbc.SQLServerDriver" />
	
	<path id="temp.classpath">
			<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
				<include name="*.jar" />
			</fileset>
	</path>
	
	
	<!--Target for Database Creation-->
	<target name="matadata_change_for_edin">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="deploy_db_mysql" />

			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="deploy_db_oracle" />
				</then>
			</elseif>
			<!-- mssqlserver db --> 
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="deploy_db_mssqlserver" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>
	
	<target name="deploy_db_oracle">
		<echo message="Initializing Oracle Database for caTissue Suite v1.1 Application..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${common.sql.dir}/update_metadata_Common_Edin.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="update_metadata_for_model_changes" />
		
	</target>
	
	
	<!--MySQL Database Creation -->
	<target name="deploy_db_mysql">
		<echo message="Initializing MySQL Database for caTissue Suite v1.1 Application..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
			<transaction src="${common.sql.dir}/update_metadata_Common_Edin.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		
		<antcall target="update_metadata_for_model_changes" />
	
	</target>
	
	<!--MsSQLServer Database Creation -->
	<target name="deploy_db_mssqlserver">
	 	<echo message="Initializing MsSQLServer Database for caTissue Suite v1.1 Application..." />
			 <sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.host}:${database.port};databaseName=${database.name};" userid="${database.username}" password="${database.password}">
			 <transaction src="${mssqlserver.sql.dir}/update_metadata_Common_Edin.sql" />	
				<classpath>
				 <fileset dir="${lib.dir}">
			     	<include name="*.jar" />
			  	 </fileset>
				</classpath>
			</sql>
			<antcall target="update_metadata_for_model_changes" />	
	</target>
	
		<!-- DE Metadata Upgradation -->
		<target name="update_metadata_for_model_changes">
			<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
     	    <delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<antcall target="update_metadata_for_model_changes_mysql" />
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<antcall target="update_metadata_for_model_changes_oracle" />
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
			<delete dir="${temp.dir}" />
	</target>
	
	
	
	
	
	
	<target name="update_metadata_for_model_changes_mysql">
			<echo message="Updating DE Metadata for model changes (mysql)....." />
			<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetaDataForEDIN"  fork="true" maxmemory="512m">
				<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<classpath refid="temp.classpath" />
     			<arg value="${database.host}"/>
				<arg value="${database.port}"/>
				<arg value="${database.type}"/>
				<arg value="${database.name}"/>
				<arg value="${database.username}"/>
				<arg value="${database.password}"/>
				<arg value="${mysql.driver.string}"/>
			</java>
     </target>

	<target name="update_metadata_for_model_changes_oracle">
			<echo message="Updating DE Metadata for model changes (oracle)....." />
			<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetaDataForEDIN"  fork="true" maxmemory="512m">
				<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<classpath refid="temp.classpath" />

				<arg value="${database.host}"/>
				<arg value="${database.port}"/>
				<arg value="${database.type}"/>
				<arg value="${database.name}"/>
				<arg value="${database.username}"/>
				<arg value="${database.password}"/>
				<arg value="${oracle.driver.string}"/>
			</java>
	<!--<antcall target="reset_sequences" />-->
	</target>
	
	<target name="reset_sequences">
		<echo message=" Resetting the sequences..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
					<transaction src="${oracle.sql.dir}/query/dropDESequence.SQL" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<transaction src="${oracle.sql.dir}/query/resetDESequence.SQL" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
		</sql>
	</target>
	
</project>